<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kyiv Power Outage Heatmap - Yasno</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            min-height: 100vh;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #fff;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .heatmap-container {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .heatmap-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #fff;
        }
        .heatmap {
            display: grid;
            grid-template-columns: repeat(48, 1fr);
            gap: 2px;
        }
        .hour-cell {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
            transition: transform 0.2s;
            cursor: pointer;
        }
        .hour-cell:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        .hour-label {
            font-size: 10px;
            opacity: 0.8;
        }
        .legend {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #16213e;
            border-radius: 12px;
            padding: 15px;
        }
        .stat-card h3 {
            color: #888;
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #e94560;
        }
        .stat-value.good {
            color: #10b981;
        }
        .stat-label {
            color: #888;
            margin-top: 5px;
            font-size: 12px;
        }
        .stat-list {
            font-size: 13px;
            color: #ccc;
        }
        .stat-list li {
            margin: 4px 0;
            list-style: none;
        }
        .summary-bar {
            background: #16213e;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }
        .summary-item {
            text-align: center;
        }
        .summary-item .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #e94560;
        }
        .summary-item .label {
            font-size: 11px;
            color: #888;
        }
        .group-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 3px;
            margin-top: 20px;
        }
        .group-cell {
            height: 12px;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            cursor: pointer;
        }
        .group-cell:hover {
            outline: 2px solid #fff;
        }
        .tooltip {
            position: fixed;
            background: #0f0f23;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 13px;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }
        .bar-chart {
            position: relative;
            height: 200px;
            padding: 10px 10px 10px 0;
        }
        .chart-grid {
            position: absolute;
            top: 10px;
            left: 40px;
            right: 0;
            bottom: 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .grid-line {
            border-top: 1px dashed #333;
            position: relative;
        }
        .grid-label {
            position: absolute;
            left: -35px;
            top: -8px;
            font-size: 10px;
            color: #666;
        }
        .chart-area {
            position: absolute;
            top: 10px;
            left: 40px;
            right: 0;
            bottom: 30px;
        }
        .chart-line {
            fill: none;
            stroke: #e94560;
            stroke-width: 2;
        }
        .chart-fill {
            fill: url(#chartGradient);
        }
        .chart-dot {
            fill: #e94560;
            cursor: pointer;
        }
        .chart-dot:hover {
            fill: #ff6b6b;
            r: 5;
        }
        .bar {
            flex: 1;
            background: linear-gradient(to top, #e94560, #ff6b6b);
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: opacity 0.2s;
        }
        .bar:hover {
            opacity: 0.8;
        }
        .bar-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #888;
        }
        .hour-labels {
            display: grid;
            grid-template-columns: repeat(48, 1fr);
            gap: 2px;
            text-align: left;
            font-size: 8px;
            color: #888;
            margin-top: 5px;
        }
        .hour-labels.chart-labels {
            margin-left: 40px;
            margin-right: 10px;
            display: flex;
            justify-content: space-between;
        }
        .hour-labels.chart-labels div {
            flex: 1;
            min-width: 0;
        }
        .hour-labels.power-status-labels {
            margin-left: 0;
            margin-right: 0;
            display: flex;
            justify-content: space-between;
        }
        .hour-labels.power-status-labels div {
            flex: 1;
            min-width: 0;
        }
        .chart-legend {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 11px;
            white-space: nowrap;
            color: #888;
        }
        .power-legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 25px;
            font-size: 11px;
            padding: 10px 0;
        }
        .power-legend span {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
        }
        .power-legend-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        .address-lookup {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .address-lookup .heatmap-title {
            margin-bottom: 12px;
        }
        .address-form {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            flex-wrap: wrap;
        }
        .address-field {
            flex: 1;
            min-width: 200px;
            position: relative;
        }
        .address-field label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .address-field input {
            width: 100%;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid #333;
            background: #1a1a2e;
            color: #eee;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        .address-field input:focus {
            border-color: #e94560;
        }
        .address-field input::placeholder {
            color: #555;
        }
        .address-field input:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .address-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #0f0f23;
            border: 1px solid #333;
            border-radius: 8px;
            margin-top: 4px;
            max-height: 220px;
            overflow-y: auto;
            z-index: 500;
            display: none;
        }
        .address-dropdown.visible {
            display: block;
        }
        .address-dropdown-item {
            padding: 10px 14px;
            font-size: 13px;
            color: #ccc;
            cursor: pointer;
            border-bottom: 1px solid #1a1a2e;
            transition: background 0.15s;
        }
        .address-dropdown-item:last-child {
            border-bottom: none;
        }
        .address-dropdown-item:hover,
        .address-dropdown-item.active {
            background: #1f2b4a;
            color: #fff;
        }
        .address-dropdown-empty {
            padding: 12px 14px;
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        .address-dropdown-loading {
            padding: 12px 14px;
            font-size: 12px;
            color: #888;
            text-align: center;
        }
        .group-result {
            display: none;
            margin-top: 15px;
            padding: 12px 18px;
            background: rgba(233, 69, 96, 0.1);
            border: 1px solid rgba(233, 69, 96, 0.3);
            border-radius: 8px;
            text-align: center;
        }
        .group-result.visible {
            display: block;
        }
        .group-result .group-number {
            font-size: 1.6em;
            font-weight: bold;
            color: #e94560;
        }
        .group-result .group-label {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }
        .group-result .group-schedule {
            margin-top: 10px;
            font-size: 13px;
            color: #ccc;
        }
        .group-result .group-schedule-off {
            color: #ef4444;
        }
        .group-result .group-schedule-on {
            color: #10b981;
        }
        .highlight-group {
            outline: 3px solid #fbbf24 !important;
            outline-offset: -1px;
            animation: pulse-highlight 1.5s ease-in-out infinite;
        }
        @keyframes pulse-highlight {
            0%, 100% { outline-color: #fbbf24; }
            50% { outline-color: #f59e0b; }
        }
        .day-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .day-toggle-group {
            display: flex;
            background: #16213e;
            border-radius: 10px;
            padding: 4px;
            gap: 4px;
        }
        .day-toggle-btn {
            padding: 8px 24px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: #888;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s ease;
            position: relative;
        }
        .day-toggle-btn:hover {
            color: #ccc;
        }
        .day-toggle-btn.active {
            background: #e94560;
            color: #fff;
            box-shadow: 0 2px 8px rgba(233, 69, 96, 0.4);
        }
        .day-toggle-btn .day-date {
            display: block;
            font-size: 10px;
            font-weight: 400;
            opacity: 0.7;
            margin-top: 2px;
        }
        /* Mobile responsive */
        @media (max-width: 1080px) {
            body {
                padding: 10px;
            }
            h1 {
                font-size: 1.3em;
            }
            .heatmap {
                grid-template-columns: repeat(24, 1fr);
            }
            .hour-labels {
                grid-template-columns: repeat(24, 1fr);
            }
            .hour-labels.mobile-2h {
                grid-template-columns: repeat(12, 1fr);
            }
            .heatmap-container {
                padding: 15px;
            }
            .stat-card {
                padding: 12px;
            }
            .summary-bar {
                padding: 10px;
            }
            .summary-item .value {
                font-size: 1.4em;
            }
            .bar-chart {
                height: 180px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° Kyiv Power Outage Heatmap</h1>
        <p class="subtitle">Yasno scheduled outages for Kyiv city</p>
        
        <div class="day-toggle">
            <div class="day-toggle-group">
                <button class="day-toggle-btn active" data-day="today" id="btnToday">üìÖ Today<span class="day-date" id="btnTodayDate"></span></button>
                <button class="day-toggle-btn" data-day="tomorrow" id="btnTomorrow">üìÖ Tomorrow<span class="day-date" id="btnTomorrowDate"></span></button>
            </div>
        </div>
        
        <div class="address-lookup">
            <div class="heatmap-title">üè† Find Your Group</div>
            <div class="address-form">
                <div class="address-field">
                    <label>Street</label>
                    <input type="text" id="streetInput" placeholder="Start typing street name..." autocomplete="off">
                    <div class="address-dropdown" id="streetDropdown"></div>
                </div>
                <div class="address-field">
                    <label>Building</label>
                    <input type="text" id="buildingInput" placeholder="Select street first" disabled autocomplete="off">
                    <div class="address-dropdown" id="buildingDropdown"></div>
                </div>
            </div>
            <div class="group-result" id="groupResult">
                <div class="group-number" id="groupNumber"></div>
                <div class="group-label" id="groupLabel"></div>
                <div class="group-schedule" id="groupSchedule"></div>
            </div>
        </div>
        
        <div class="summary-bar" id="summaryBar"></div>
        
        <div class="stats" id="stats"></div>
        
        <div class="heatmap-container">
            <div class="heatmap-title">üìä Outage Intensity by 30-min Slot (% of groups affected)</div>
            <div id="heatmapWrapper"></div>
            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background: #10b981;"></div> 0-20%</div>
                <div class="legend-item"><div class="legend-color" style="background: #84cc16;"></div> 20-40%</div>
                <div class="legend-item"><div class="legend-color" style="background: #eab308;"></div> 40-60%</div>
                <div class="legend-item"><div class="legend-color" style="background: #f97316;"></div> 60-80%</div>
                <div class="legend-item"><div class="legend-color" style="background: #ef4444;"></div> 80-100%</div>
            </div>
        </div>
        
        <div class="heatmap-container">
            <div class="heatmap-title">üìà Outages Over Time (groups without power)</div>
            <div class="bar-chart" id="barChart">
                <svg width="100%" height="100%" id="lineChart"></svg>
            </div>
            <div class="hour-labels chart-labels" id="barLabels"></div>
            <div class="chart-legend" id="barChartLegend"></div>
        </div>
        
        <div class="heatmap-container">
            <div class="heatmap-title">üîã Power Status by 30-min Slot</div>
            <div id="powerStatusChart" style="height: 60px; position: relative; margin-bottom: 10px;"></div>
            <div class="hour-labels power-status-labels" id="powerStatusLabels"></div>
            <div class="chart-legend" id="powerStatusLegend"></div>
        </div>
        
        <div class="heatmap-container">
            <div class="heatmap-title">üî≤ Detailed Grid: Groups √ó Hours (hover for details)</div>
            <div style="overflow-x: auto;">
                <div id="detailedGridHeader" style="display: grid; grid-template-columns: 50px repeat(48, 1fr); gap: 1px; min-width: 800px;">
                    <div></div>
                </div>
                <div id="detailedGrid" style="min-width: 800px;"></div>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Loading outage data...</p>
    </div>
    
    <div class="error" id="error" style="display: none;">
        <p>‚ùå Failed to load data</p>
        <p id="errorMessage"></p>
        <button onclick="fetchData()">üîÑ Retry</button>
    </div>
    
    <script>
        const API_URL = 'https://app.yasno.ua/api/blackout-service/public/shutdowns/regions/25/dsos/902/planned-outages';
        
        // Multiple CORS proxies to try (fallback chain)
        // All must return Access-Control-Allow-Origin: * to work from file:// (null origin)
        const CORS_PROXIES = [
            { name: 'allorigins', url: 'https://api.allorigins.win/get?url=', jsonWrapped: true },
            { name: 'corsproxy.io', url: 'https://corsproxy.io/?' },
            { name: 'corsanywhere', url: 'https://api.codetabs.com/v1/proxy?quest=' }
        ];
        
        // Add loading and error styles
        const style = document.createElement('style');
        style.textContent = `
            .loading {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 60px;
                color: #888;
            }
            .spinner {
                width: 50px;
                height: 50px;
                border: 4px solid #16213e;
                border-top-color: #e94560;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 20px;
            }
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
            .error {
                text-align: center;
                padding: 40px;
                color: #ef4444;
            }
            .error button {
                margin-top: 15px;
                padding: 10px 25px;
                background: #e94560;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
            }
            .error button:hover {
                background: #d63050;
            }
            .refresh-btn {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 10px 20px;
                background: #16213e;
                color: #fff;
                border: 1px solid #333;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                z-index: 100;
                transition: background 0.2s;
            }
            .refresh-btn:hover {
                background: #1f2b4a;
            }
            .last-updated {
                text-align: center;
                color: #666;
                font-size: 12px;
                margin-bottom: 20px;
            }
        `;
        document.head.appendChild(style);
        
        let outageData = null;
        let selectedDay = 'today';

        // Parse data and calculate outages per 30-min slot
        function parseOutages(data, day) {
            day = day || selectedDay;
            const groups = Object.keys(data);
            const slotOutages = new Array(48).fill(0); // 48 x 30-min slots
            const groupSlotData = {};
            const groupStats = {}; // Track outage duration per group
            
            groups.forEach(groupId => {
                const slots = data[groupId][day]?.slots || [];
                groupSlotData[groupId] = new Array(48).fill(false);
                groupStats[groupId] = { outageMinutes: 0, outagePeriods: [] };
                
                slots.forEach(slot => {
                    if (slot.type === 'Definite') {
                        // Calculate outage duration
                        groupStats[groupId].outageMinutes += (slot.end - slot.start);
                        groupStats[groupId].outagePeriods.push({ start: slot.start, end: slot.end });
                        
                        const startSlot = Math.floor(slot.start / 30);
                        const endSlot = Math.ceil(slot.end / 30);
                        
                        for (let s = startSlot; s < endSlot && s < 48; s++) {
                            const slotStart = s * 30;
                            const slotEnd = (s + 1) * 30;
                            if (slot.start < slotEnd && slot.end > slotStart) {
                                if (!groupSlotData[groupId][s]) {
                                    groupSlotData[groupId][s] = true;
                                    slotOutages[s]++;
                                }
                            }
                        }
                    }
                });
            });
            
            return { hourlyOutages: slotOutages, groups, groupHourData: groupSlotData, groupStats };
        }

        function findConsecutiveRanges(slots, values, condition) {
            const matchingSlots = slots.map((v, i) => condition(v) ? i : -1).filter(i => i >= 0);
            if (matchingSlots.length === 0) return [];
            
            const ranges = [];
            let rangeStart = matchingSlots[0];
            let rangeEnd = matchingSlots[0];
            
            for (let i = 1; i < matchingSlots.length; i++) {
                if (matchingSlots[i] === rangeEnd + 1) {
                    rangeEnd = matchingSlots[i];
                } else {
                    ranges.push({ start: rangeStart, end: rangeEnd });
                    rangeStart = matchingSlots[i];
                    rangeEnd = matchingSlots[i];
                }
            }
            ranges.push({ start: rangeStart, end: rangeEnd });
            
            return ranges;
        }

        function formatRanges(ranges) {
            return ranges.map(r => {
                if (r.start === r.end) {
                    return formatSlotTime(r.start);
                }
                return `${formatSlotTime(r.start)}-${formatSlotTime(r.end + 1)}`;
            }).join(', ');
        }

        function formatDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (hours === 0) return `${mins}m`;
            if (mins === 0) return `${hours}h`;
            return `${hours}h ${mins}m`;
        }

        function formatGroupId(groupId, allGroups) {
            // Check if all groups end with .1
            const allEndWith1 = allGroups.every(g => g.endsWith('.1'));
            if (allEndWith1 && groupId.endsWith('.1')) {
                return groupId.slice(0, -2);
            }
            return groupId;
        }

        function formatGroupIds(groupIds, allGroups) {
            return groupIds.map(id => formatGroupId(id, allGroups)).join(', ');
        }

        function getColor(percentage) {
            if (percentage >= 80) return '#ef4444';
            if (percentage >= 60) return '#f97316';
            if (percentage >= 40) return '#eab308';
            if (percentage >= 20) return '#84cc16';
            return '#10b981';
        }

        function formatSlotTime(slot) {
            const hour = Math.floor(slot / 2);
            const min = slot % 2 === 0 ? '00' : '30';
            return `${hour}:${min}`;
        }

        function renderHeatmap(hourlyOutages, totalGroups) {
            const wrapper = document.getElementById('heatmapWrapper');
            wrapper.innerHTML = '';
            const isMobile = window.innerWidth <= 1080;
            
            function createCell(slot, count) {
                const percentage = (count / totalGroups) * 100;
                const cell = document.createElement('div');
                cell.className = 'hour-cell';
                cell.style.backgroundColor = getColor(percentage);
                cell.style.color = percentage > 50 ? '#fff' : '#000';
                cell.innerHTML = `<span>${Math.round(percentage)}%</span>`;
                cell.title = `${formatSlotTime(slot)} - ${formatSlotTime(slot + 1)}\n${count} groups affected (${percentage.toFixed(1)}%)`;
                return cell;
            }
            
            function createLabels(startSlot, endSlot, cols) {
                const labelsDiv = document.createElement('div');
                labelsDiv.className = 'hour-labels';
                labelsDiv.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
                labelsDiv.style.marginLeft = '0';
                labelsDiv.style.marginRight = '0';
                for (let i = startSlot; i < endSlot; i++) {
                    const label = document.createElement('div');
                    // Show label every 2 hours (every 4 slots)
                    if ((i - startSlot) % 4 === 0) {
                        label.textContent = `${Math.floor(i / 2)}`;
                    }
                    labelsDiv.appendChild(label);
                }
                return labelsDiv;
            }
            
            if (isMobile) {
                // Mobile: 2 rows with labels above first row and below second row
                // Row 1 labels (0:00 - 11:30)
                const labels1 = createLabels(0, 24, 24);
                labels1.style.marginBottom = '3px';
                wrapper.appendChild(labels1);
                
                // Row 1 cells (slots 0-23)
                const row1 = document.createElement('div');
                row1.className = 'heatmap';
                row1.style.gridTemplateColumns = 'repeat(24, 1fr)';
                for (let slot = 0; slot < 24; slot++) {
                    row1.appendChild(createCell(slot, hourlyOutages[slot]));
                }
                wrapper.appendChild(row1);
                
                // Row 2 cells (slots 24-47)
                const row2 = document.createElement('div');
                row2.className = 'heatmap';
                row2.style.gridTemplateColumns = 'repeat(24, 1fr)';
                row2.style.marginTop = '8px';
                for (let slot = 24; slot < 48; slot++) {
                    row2.appendChild(createCell(slot, hourlyOutages[slot]));
                }
                wrapper.appendChild(row2);
                
                // Row 2 labels (12:00 - 23:30)
                const labels2 = createLabels(24, 48, 24);
                labels2.style.marginTop = '3px';
                wrapper.appendChild(labels2);
            } else {
                // Desktop: single row of 48 cells with labels below
                const heatmapRow = document.createElement('div');
                heatmapRow.className = 'heatmap';
                heatmapRow.style.gridTemplateColumns = 'repeat(48, 1fr)';
                for (let slot = 0; slot < 48; slot++) {
                    heatmapRow.appendChild(createCell(slot, hourlyOutages[slot]));
                }
                wrapper.appendChild(heatmapRow);
                
                // Labels below
                const labels = document.createElement('div');
                labels.className = 'hour-labels';
                labels.style.gridTemplateColumns = 'repeat(48, 1fr)';
                labels.style.marginLeft = '0';
                labels.style.marginRight = '0';
                for (let i = 0; i < 48; i++) {
                    const label = document.createElement('div');
                    label.textContent = i % 2 === 0 ? `${Math.floor(i / 2)}` : '';
                    labels.appendChild(label);
                }
                wrapper.appendChild(labels);
            }
        }

        function renderBarChart(hourlyOutages, totalGroups) {
            const container = document.getElementById('barChart');
            const labels = document.getElementById('barLabels');
            const svg = document.getElementById('lineChart');
            const maxCount = totalGroups; // Use total groups as max scale
            const isMobile = window.innerWidth <= 1080;
            
            // Get container dimensions
            const rect = container.getBoundingClientRect();
            const leftPadding = 40;
            const rightPadding = 10;
            const topPadding = 10;
            const bottomPadding = 10;
            const width = rect.width - leftPadding - rightPadding;
            const height = rect.height - topPadding - bottomPadding;
            const dotRadius = isMobile ? 2 : 3;
            
            // Create SVG content
            const gridLines = isMobile ? 4 : 5;
            let svgContent = `
                <defs>
                    <linearGradient id="chartGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#e94560;stop-opacity:0.4"/>
                        <stop offset="100%" style="stop-color:#e94560;stop-opacity:0.05"/>
                    </linearGradient>
                </defs>
            `;
            
            // Draw grid lines
            for (let i = 0; i <= gridLines; i++) {
                const y = topPadding + (height / gridLines) * i;
                const value = Math.round(maxCount - (maxCount / gridLines) * i);
                svgContent += `
                    <line x1="${leftPadding}" y1="${y}" x2="${leftPadding + width}" y2="${y}" stroke="#333" stroke-dasharray="4"/>
                    <text x="${leftPadding - 5}" y="${y + 4}" text-anchor="end" fill="#666" font-size="10">${value}</text>
                `;
            }
            
            // Build line path
            const points = hourlyOutages.map((count, i) => {
                const x = leftPadding + (width / 47) * i;
                const y = topPadding + height - (count / maxCount) * height;
                return { x, y, count, slot: i };
            });
            
            const linePath = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
            const areaPath = `${linePath} L ${points[points.length-1].x} ${topPadding + height} L ${points[0].x} ${topPadding + height} Z`;
            
            svgContent += `<path d="${areaPath}" class="chart-fill"/>`;
            svgContent += `<path d="${linePath}" class="chart-line"/>`;
            
            // Add dots - on mobile, show fewer dots
            const dotInterval = isMobile ? 2 : 1; // Show every 2nd dot on mobile
            points.forEach((p, idx) => {
                if (idx % dotInterval === 0) {
                    svgContent += `<circle cx="${p.x}" cy="${p.y}" r="${dotRadius}" class="chart-dot">
                        <title>${formatSlotTime(p.slot)}: ${p.count} groups</title>
                    </circle>`;
                }
            });
            
            // Y-axis label
            svgContent += `<text x="12" y="${topPadding + height/2}" text-anchor="middle" fill="#888" font-size="10" transform="rotate(-90, 12, ${topPadding + height/2})">Groups</text>`;
            
            svg.innerHTML = svgContent;
            
            // X-axis labels - show fewer on mobile, aligned with chart
            labels.innerHTML = '';
            const labelInterval = isMobile ? 4 : 2; // Every 2h on mobile, every 1h on desktop
            for (let slot = 0; slot < 48; slot++) {
                const label = document.createElement('div');
                label.textContent = slot % labelInterval === 0 ? `${Math.floor(slot/2)}` : '';
                labels.appendChild(label);
            }
            
            // Add chart legend below labels
            const legendContainer = document.getElementById('barChartLegend');
            legendContainer.innerHTML = '<span style="color:#e94560;">‚óè</span> Groups without power';
        }

        function renderPowerStatusChart(hourlyOutages, totalGroups) {
            const container = document.getElementById('powerStatusChart');
            const labels = document.getElementById('powerStatusLabels');
            container.innerHTML = '';
            labels.innerHTML = '';
            
            const wrapper = document.createElement('div');
            wrapper.style.cssText = 'display: flex; height: 100%; gap: 1px;';
            
            hourlyOutages.forEach((outageCount, slot) => {
                const powerOnCount = totalGroups - outageCount;
                const outagePercent = (outageCount / totalGroups) * 100;
                
                const bar = document.createElement('div');
                bar.style.cssText = `flex: 1; display: flex; flex-direction: column; border-radius: 2px; overflow: hidden;`;
                bar.innerHTML = `
                    <div style="flex: ${outageCount}; background: #ef4444;" title="${formatSlotTime(slot)}: ${outageCount} groups OFF"></div>
                    <div style="flex: ${powerOnCount}; background: #10b981;" title="${formatSlotTime(slot)}: ${powerOnCount} groups ON"></div>
                `;
                wrapper.appendChild(bar);
            });
            
            container.appendChild(wrapper);
            
            // X-axis labels - single row using flexbox via chart-labels class
            const isMobile = window.innerWidth <= 1080;
            const labelInterval = isMobile ? 4 : 2;
            for (let slot = 0; slot < 48; slot++) {
                const label = document.createElement('div');
                label.textContent = slot % labelInterval === 0 ? `${Math.floor(slot/2)}` : '';
                labels.appendChild(label);
            }
            
            // Add legend below labels (same style as Outages Over Time)
            const legendContainer = document.getElementById('powerStatusLegend');
            legendContainer.innerHTML = '<span style="color:#ef4444;">‚óè</span> Power OFF &nbsp;&nbsp; <span style="color:#10b981;">‚óè</span> Power ON';
        }

        function renderDetailedGrid(groupHourData, groups) {
            const container = document.getElementById('detailedGrid');
            const header = document.getElementById('detailedGridHeader');
            const tooltip = document.getElementById('tooltip');
            
            // Build header with time labels
            const isMobile = window.innerWidth <= 1080;
            header.innerHTML = '<div></div>';
            for (let i = 0; i < 48; i++) {
                const div = document.createElement('div');
                div.style.cssText = 'text-align: center; font-size: 7px; color: #888;';
                if (isMobile) {
                    // On mobile, show only every 2 hours (every 4 slots)
                    div.textContent = i % 4 === 0 ? `${Math.floor(i/2)}h` : '';
                } else {
                    div.textContent = `${Math.floor(i/2)}:${i%2===0?'00':'30'}`;
                }
                header.appendChild(div);
            }
            
            groups.sort((a, b) => {
                const numA = parseFloat(a);
                const numB = parseFloat(b);
                return numA - numB;
            });
            
            groups.forEach(groupId => {
                const row = document.createElement('div');
                row.style.display = 'grid';
                row.style.gridTemplateColumns = '50px repeat(48, 1fr)';
                row.style.gap = '1px';
                row.style.marginBottom = '1px';
                
                const label = document.createElement('div');
                label.textContent = formatGroupId(groupId, groups);
                label.style.fontSize = '9px';
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.justifyContent = 'center';
                label.style.color = '#888';
                row.appendChild(label);
                
                for (let s = 0; s < 48; s++) {
                    const cell = document.createElement('div');
                    cell.className = 'group-cell';
                    const hasOutage = groupHourData[groupId][s];
                    cell.style.backgroundColor = hasOutage ? '#ef4444' : '#10b981';
                    
                    cell.addEventListener('mouseenter', (e) => {
                        tooltip.style.display = 'block';
                        tooltip.innerHTML = `<strong>Group ${formatGroupId(groupId, groups)}</strong><br>${formatSlotTime(s)} - ${formatSlotTime(s + 1)}<br>${hasOutage ? '‚ö†Ô∏è Outage' : '‚úÖ Power on'}`;
                        tooltip.style.left = (e.clientX + 10) + 'px';
                        tooltip.style.top = (e.clientY + 10) + 'px';
                    });
                    
                    cell.addEventListener('mouseleave', () => {
                        tooltip.style.display = 'none';
                    });
                    
                    row.appendChild(cell);
                }
                
                container.appendChild(row);
            });
        }

        function renderStats(hourlyOutages, totalGroups, groupStats, allGroups) {
            const container = document.getElementById('stats');
            const summaryBar = document.getElementById('summaryBar');
            container.innerHTML = '';
            summaryBar.innerHTML = '';
            
            const maxOutages = Math.max(...hourlyOutages);
            const minOutages = Math.min(...hourlyOutages);
            const avgOutages = hourlyOutages.reduce((a, b) => a + b, 0) / 48;
            
            // Find worst and best slots (all of them)
            const worstRanges = findConsecutiveRanges(hourlyOutages, hourlyOutages, v => v === maxOutages);
            const bestRanges = findConsecutiveRanges(hourlyOutages, hourlyOutages, v => v === minOutages);
            
            // Find worst and best groups
            const groupDurations = Object.entries(groupStats).map(([id, stats]) => ({
                id,
                minutes: stats.outageMinutes,
                powerOnMinutes: 1440 - stats.outageMinutes
            })).sort((a, b) => b.minutes - a.minutes);
            
            const worstDuration = groupDurations[0]?.minutes || 0;
            const bestDuration = groupDurations[groupDurations.length - 1]?.minutes || 0;
            
            const worstGroups = groupDurations.filter(g => g.minutes === worstDuration).slice(0, 5);
            const bestGroups = groupDurations.filter(g => g.minutes === bestDuration).slice(0, 5);
            
            // Summary bar
            summaryBar.innerHTML = `
                <div class="summary-item">
                    <div class="value">${totalGroups}</div>
                    <div class="label">Total Groups</div>
                </div>
                <div class="summary-item">
                    <div class="value">${formatDuration(worstDuration)}</div>
                    <div class="label">Max Outage Duration</div>
                </div>
                <div class="summary-item">
                    <div class="value">${formatDuration(bestDuration)}</div>
                    <div class="label">Min Outage Duration</div>
                </div>
                <div class="summary-item">
                    <div class="value">${formatDuration(Math.round(groupDurations.reduce((a, g) => a + g.minutes, 0) / groupDurations.length))}</div>
                    <div class="label">Avg Outage Duration</div>
                </div>
            `;
            
            // Stats cards
            const cards = [
                {
                    title: 'üî¥ Worst Time Slots',
                    value: formatRanges(worstRanges),
                    label: `${maxOutages} groups affected (${Math.round(maxOutages/totalGroups*100)}%)`,
                    isGood: false
                },
                {
                    title: 'üü¢ Best Time Slots',
                    value: formatRanges(bestRanges),
                    label: `${minOutages} groups affected (${Math.round(minOutages/totalGroups*100)}%)`,
                    isGood: true
                },
                {
                    title: 'üòì Most Affected Groups',
                    value: formatGroupIds(worstGroups.map(g => g.id), allGroups),
                    label: `${formatDuration(worstDuration)} without power`,
                    isGood: false
                },
                {
                    title: 'üòä Least Affected Groups',
                    value: formatGroupIds(bestGroups.map(g => g.id), allGroups),
                    label: `${formatDuration(bestDuration)} without power`,
                    isGood: true
                }
            ];
            
            cards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'stat-card';
                cardEl.innerHTML = `
                    <h3>${card.title}</h3>
                    <div class="stat-value ${card.isGood ? 'good' : ''}">${card.value}</div>
                    <div class="stat-label">${card.label}</div>
                `;
                container.appendChild(cardEl);
            });
        }

        function clearAllContainers() {
            document.getElementById('stats').innerHTML = '';
            document.getElementById('summaryBar').innerHTML = '';
            document.getElementById('heatmapWrapper').innerHTML = '';
            document.getElementById('barChart').innerHTML = '<svg width="100%" height="100%" id="lineChart"></svg>';
            document.getElementById('barLabels').innerHTML = '';
            document.getElementById('powerStatusChart').innerHTML = '';
            document.getElementById('powerStatusLabels').innerHTML = '';
            document.getElementById('detailedGrid').innerHTML = '';
            document.getElementById('detailedGridHeader').innerHTML = '<div></div>';
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('error').style.display = 'none';
            document.querySelector('.container').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.querySelector('.container').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
            document.querySelector('.container').style.display = 'none';
        }

        function updateSubtitle(data, day) {
            day = day || selectedDay;
            const subtitle = document.querySelector('.subtitle');
            const firstGroup = Object.values(data)[0];
            const dayLabel = day === 'today' ? 'Today' : 'Tomorrow';
            if (firstGroup?.[day]?.date) {
                const date = new Date(firstGroup[day].date);
                subtitle.textContent = `${dayLabel}'s planned outages (${date.toLocaleDateString('en-US', { 
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                })})`;
            }
            
            // Populate toggle button dates
            if (firstGroup?.today?.date) {
                const todayDate = new Date(firstGroup.today.date);
                document.getElementById('btnTodayDate').textContent = todayDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            if (firstGroup?.tomorrow?.date) {
                const tomorrowDate = new Date(firstGroup.tomorrow.date);
                document.getElementById('btnTomorrowDate').textContent = tomorrowDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            
            // Add last updated info
            if (firstGroup?.updatedOn) {
                const updated = new Date(firstGroup.updatedOn);
                let lastUpdatedDiv = document.querySelector('.last-updated');
                if (!lastUpdatedDiv) {
                    lastUpdatedDiv = document.createElement('div');
                    lastUpdatedDiv.className = 'last-updated';
                    document.querySelector('.day-toggle').after(lastUpdatedDiv);
                }
                lastUpdatedDiv.textContent = `Last updated: ${updated.toLocaleString()}`;
            }
        }

        // ---- Address lookup ----
        const STREETS_API = 'https://app.yasno.ua/api/blackout-service/public/shutdowns/addresses/v2/streets';
        const HOUSES_API = 'https://app.yasno.ua/api/blackout-service/public/shutdowns/addresses/v2/houses';
        const GROUP_API = 'https://app.yasno.ua/api/blackout-service/public/shutdowns/addresses/v2/group';
        const REGION_ID = 25;
        const DSO_ID = 902;

        let selectedStreet = null;
        let selectedBuilding = null;
        let highlightedGroupId = null;
        let streetDebounce = null;
        let buildingDebounce = null;
        let activeDropdownIndex = -1;

        const streetInput = document.getElementById('streetInput');
        const buildingInput = document.getElementById('buildingInput');
        const streetDropdown = document.getElementById('streetDropdown');
        const buildingDropdown = document.getElementById('buildingDropdown');
        const groupResult = document.getElementById('groupResult');

        async function fetchViaProxy(apiUrl) {
            for (const proxy of CORS_PROXIES) {
                try {
                    const res = await fetch(proxy.url + encodeURIComponent(apiUrl));
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    if (proxy.jsonWrapped) {
                        const wrapper = await res.json();
                        return JSON.parse(wrapper.contents);
                    }
                    return await res.json();
                } catch(e) {
                    continue;
                }
            }
            throw new Error('All proxies failed');
        }

        function showDropdown(dropdown, items, onSelect, emptyMsg) {
            activeDropdownIndex = -1;
            if (!items || items.length === 0) {
                dropdown.innerHTML = `<div class="address-dropdown-empty">${emptyMsg || 'No results'}</div>`;
                dropdown.classList.add('visible');
                return;
            }
            dropdown.innerHTML = items.map((item, i) =>
                `<div class="address-dropdown-item" data-index="${i}">${item.value}</div>`
            ).join('');
            dropdown.classList.add('visible');
            dropdown.querySelectorAll('.address-dropdown-item').forEach((el, i) => {
                el.addEventListener('click', () => onSelect(items[i]));
            });
        }

        function hideDropdown(dropdown) {
            dropdown.classList.remove('visible');
            dropdown.innerHTML = '';
            activeDropdownIndex = -1;
        }

        function navigateDropdown(dropdown, items, onSelect, direction) {
            const els = dropdown.querySelectorAll('.address-dropdown-item');
            if (els.length === 0) return;
            if (activeDropdownIndex >= 0 && els[activeDropdownIndex]) {
                els[activeDropdownIndex].classList.remove('active');
            }
            activeDropdownIndex += direction;
            if (activeDropdownIndex < 0) activeDropdownIndex = els.length - 1;
            if (activeDropdownIndex >= els.length) activeDropdownIndex = 0;
            els[activeDropdownIndex].classList.add('active');
            els[activeDropdownIndex].scrollIntoView({ block: 'nearest' });
        }

        function clearGroupHighlight() {
            document.querySelectorAll('.highlight-group').forEach(el => el.classList.remove('highlight-group'));
            highlightedGroupId = null;
        }

        function applyGroupHighlight() {
            clearGroupHighlight();
            if (!highlightedGroupId) return;
            // Find the row in detailed grid matching this group
            const grid = document.getElementById('detailedGrid');
            const rows = grid.children;
            for (const row of rows) {
                const label = row.children[0];
                if (label && label.textContent === highlightedGroupId) {
                    row.classList.add('highlight-group');
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    break;
                }
            }
        }

        function formatGroupSchedule(groupId, day) {
            if (!outageData || !outageData[groupId]) return '';
            const dayData = outageData[groupId][day || selectedDay];
            if (!dayData?.slots) return '';
            return dayData.slots.map(s => {
                const startH = Math.floor(s.start / 60);
                const startM = s.start % 60;
                const endH = Math.floor(s.end / 60);
                const endM = s.end % 60;
                const from = `${startH}:${String(startM).padStart(2,'0')}`;
                const to = `${endH}:${String(endM).padStart(2,'0')}`;
                if (s.type === 'Definite') {
                    return `<span class="group-schedule-off">‚ö° ${from}‚Äì${to} OFF</span>`;
                } else {
                    return `<span class="group-schedule-on">‚úÖ ${from}‚Äì${to} ON</span>`;
                }
            }).join(' &nbsp; ');
        }

        streetInput.addEventListener('input', () => {
            const q = streetInput.value.trim();
            selectedStreet = null;
            selectedBuilding = null;
            buildingInput.value = '';
            buildingInput.disabled = true;
            hideDropdown(buildingDropdown);
            groupResult.classList.remove('visible');
            clearGroupHighlight();

            if (q.length < 2) {
                hideDropdown(streetDropdown);
                return;
            }
            clearTimeout(streetDebounce);
            streetDropdown.innerHTML = '<div class="address-dropdown-loading">Searching...</div>';
            streetDropdown.classList.add('visible');
            streetDebounce = setTimeout(async () => {
                try {
                    const url = `${STREETS_API}?regionId=${REGION_ID}&query=${encodeURIComponent(q)}&dsoId=${DSO_ID}`;
                    const results = await fetchViaProxy(url);
                    showDropdown(streetDropdown, results, (item) => {
                        selectedStreet = item;
                        streetInput.value = item.value;
                        hideDropdown(streetDropdown);
                        buildingInput.disabled = false;
                        buildingInput.placeholder = 'Start typing or browse...';
                        buildingInput.value = '';
                        buildingInput.focus();
                        // Preload buildings
                        loadBuildings('');
                    }, 'No streets found');
                } catch(e) {
                    streetDropdown.innerHTML = '<div class="address-dropdown-empty">Error loading streets</div>';
                }
            }, 300);
        });

        streetInput.addEventListener('keydown', (e) => {
            if (!streetDropdown.classList.contains('visible')) return;
            const items = streetDropdown.querySelectorAll('.address-dropdown-item');
            if (e.key === 'ArrowDown') { e.preventDefault(); navigateDropdown(streetDropdown, null, null, 1); }
            else if (e.key === 'ArrowUp') { e.preventDefault(); navigateDropdown(streetDropdown, null, null, -1); }
            else if (e.key === 'Enter' && activeDropdownIndex >= 0 && items[activeDropdownIndex]) {
                e.preventDefault(); items[activeDropdownIndex].click();
            }
            else if (e.key === 'Escape') { hideDropdown(streetDropdown); }
        });

        async function loadBuildings(query) {
            if (!selectedStreet) return;
            buildingDropdown.innerHTML = '<div class="address-dropdown-loading">Loading...</div>';
            buildingDropdown.classList.add('visible');
            try {
                const url = `${HOUSES_API}?regionId=${REGION_ID}&streetId=${selectedStreet.id}&query=${encodeURIComponent(query)}&dsoId=${DSO_ID}`;
                const results = await fetchViaProxy(url);
                showDropdown(buildingDropdown, results, (item) => {
                    selectedBuilding = item;
                    buildingInput.value = item.value;
                    hideDropdown(buildingDropdown);
                    lookupGroup();
                }, 'No buildings found');
            } catch(e) {
                buildingDropdown.innerHTML = '<div class="address-dropdown-empty">Error loading buildings</div>';
            }
        }

        buildingInput.addEventListener('input', () => {
            const q = buildingInput.value.trim();
            selectedBuilding = null;
            groupResult.classList.remove('visible');
            clearGroupHighlight();
            clearTimeout(buildingDebounce);
            buildingDebounce = setTimeout(() => loadBuildings(q), 250);
        });

        buildingInput.addEventListener('focus', () => {
            if (selectedStreet && !selectedBuilding && buildingInput.value.trim().length === 0) {
                loadBuildings('');
            }
        });

        buildingInput.addEventListener('keydown', (e) => {
            if (!buildingDropdown.classList.contains('visible')) return;
            const items = buildingDropdown.querySelectorAll('.address-dropdown-item');
            if (e.key === 'ArrowDown') { e.preventDefault(); navigateDropdown(buildingDropdown, null, null, 1); }
            else if (e.key === 'ArrowUp') { e.preventDefault(); navigateDropdown(buildingDropdown, null, null, -1); }
            else if (e.key === 'Enter' && activeDropdownIndex >= 0 && items[activeDropdownIndex]) {
                e.preventDefault(); items[activeDropdownIndex].click();
            }
            else if (e.key === 'Escape') { hideDropdown(buildingDropdown); }
        });

        async function lookupGroup() {
            if (!selectedStreet || !selectedBuilding) return;
            try {
                const url = `${GROUP_API}?regionId=${REGION_ID}&streetId=${selectedStreet.id}&houseId=${selectedBuilding.id}&dsoId=${DSO_ID}`;
                const data = await fetchViaProxy(url);
                const groupId = `${data.group}.${data.subgroup}`;
                highlightedGroupId = String(data.group);

                document.getElementById('groupNumber').textContent = `Group ${data.group}.${data.subgroup}`;
                document.getElementById('groupLabel').textContent = `${selectedStreet.value}, ${selectedBuilding.value}`;
                document.getElementById('groupSchedule').innerHTML = formatGroupSchedule(groupId, selectedDay);
                groupResult.classList.add('visible');

                applyGroupHighlight();
            } catch(e) {
                document.getElementById('groupNumber').textContent = 'Error';
                document.getElementById('groupLabel').textContent = 'Could not determine group';
                document.getElementById('groupSchedule').innerHTML = '';
                groupResult.classList.add('visible');
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.address-field')) {
                hideDropdown(streetDropdown);
                hideDropdown(buildingDropdown);
            }
        });

        function renderAll(data, day) {
            clearAllContainers();
            const { hourlyOutages, groups, groupHourData, groupStats } = parseOutages(data, day);
            updateSubtitle(data, day);
            renderStats(hourlyOutages, groups.length, groupStats, groups);
            renderHeatmap(hourlyOutages, groups.length);
            renderBarChart(hourlyOutages, groups.length);
            renderPowerStatusChart(hourlyOutages, groups.length);
            renderDetailedGrid(groupHourData, groups);
            // Re-apply group highlight & schedule after re-render
            if (highlightedGroupId) {
                applyGroupHighlight();
            }
            if (groupResult.classList.contains('visible') && selectedStreet && selectedBuilding) {
                const gId = document.getElementById('groupNumber').textContent.replace('Group ', '');
                document.getElementById('groupSchedule').innerHTML = formatGroupSchedule(gId, day);
            }
        }

        // Day toggle handling
        document.querySelectorAll('.day-toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.dataset.day === selectedDay) return;
                selectedDay = btn.dataset.day;
                document.querySelectorAll('.day-toggle-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                if (outageData) {
                    renderAll(outageData, selectedDay);
                }
            });
        });

        async function fetchData() {
            showLoading();
            
            let lastError = null;
            
            // Try each CORS proxy in order until one works
            for (const proxy of CORS_PROXIES) {
                try {
                    console.log(`Trying ${proxy.name}...`);
                    const response = await fetch(proxy.url + encodeURIComponent(API_URL), {
                        headers: {
                            'Accept': 'application/json, text/plain, */*'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    if (proxy.jsonWrapped) {
                        const wrapper = await response.json();
                        outageData = JSON.parse(wrapper.contents);
                    } else {
                        outageData = await response.json();
                    }
                    
                    if (!outageData || Object.keys(outageData).length === 0) {
                        throw new Error('No outage data received');
                    }
                    
                    console.log(`Success with ${proxy.name}`);
                    hideLoading();
                    renderAll(outageData, selectedDay);
                    
                    // Add refresh button if not exists
                    if (!document.querySelector('.refresh-btn')) {
                        const refreshBtn = document.createElement('button');
                        refreshBtn.className = 'refresh-btn';
                        refreshBtn.innerHTML = 'üîÑ Refresh';
                        refreshBtn.onclick = fetchData;
                        document.body.appendChild(refreshBtn);
                    }
                    
                    return; // Success - exit the function
                    
                } catch (error) {
                    console.warn(`${proxy.name} failed:`, error.message);
                    lastError = error;
                    // Continue to next proxy
                }
            }
            
            // All proxies failed
            console.error('All CORS proxies failed');
            showError(lastError?.message || 'All CORS proxies failed. Please try again later.');
        }

        // Initialize - fetch data on page load
        fetchData();
        
        // Re-render on window resize for mobile responsiveness
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (outageData) {
                    renderAll(outageData, selectedDay);
                }
            }, 250);
        });
    </script>
</body>
</html>
